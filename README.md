# Arch Avisto WSL

This project contains the sources and the documentation to ship updates of the
Arch Avisto image.

For documentation about the [installation](https://advans-group.atlassian.net/wiki/spaces/DS/pages/2919563271/WSL+2+Get+started#%F0%9F%86%95-Import-Avisto-image-[Recommended]) as a consumer.

## Setup

### Pre-commit

This project uses pre-commit tool [documentation](https://pre-commit.com/).

The goal is to run scripts or tasks (called hooks) on a commit basis
(e.g. linting, small checks, documentation as code, etc.).

For this purpose, pre-commit will execute all the hooks declared in in then
`.pre-commit-config.yaml` configuration file.

1. Install the tool. `pip install pre-commit`
2. Install the git hook. `pre-commit install`
3. Verify it is working by running pre-commit hooks. `pre-commit run --all-files`

### Golang

The bootscript is written in [Golang](https://golang.org/)

## Introduction

### History

The aim of Arch Avisto was to deliver a container solution (docker in our case)
out-of-the box for the teams without relaying on Docker Desktop,
for licence reasons. Indeed, its installation on WSL was error prone and time consuming.

Arch Avisto is based on [Arch Linux](https://archlinux.org/), and its first
version was born using [ArchWSL](https://github.com/yuk7/ArchWSL).

### Architecture

There are two users in this image

- `arch` is the normal user.
- `login` is the default user on the first launch. Its job is to launch the bootscript.

They are a few important files on the Arch Avisto WSL image.

Static files:

- `/home/arch` is the home of the default user, containing `.oh-my-zsh`,
  `.zshrc` and `.config/starship.toml` as basic configuration
- `/opt/prep.sh` is a script to prepare the image (clearing history and caches). It should be manually used before exporting.
- `/usr/bin/slogin` is the shell of the `login` user. This shell is responsible to download and run `bootscript`, then start the bash script generated by `bootscript`

Other files:

- `/opt/startup/bootscript` is the binary executed by `slogin`
  on startup, it will be fetched from the Gitlab package registry and is
  responsible to prompt the user for the packages he wants, his username, etc.
- `/opt/startup/script.sh` is the script generated by the binary `bootscript` and executed by `slogin`, it contains all bash commands that will set up the images

> ⓘ **Note**
> The bootscript will try to fetch and parse the file `packagesProfiles.json`
> located in the Gitlab repository in order to prompt the user the latest
> packages without having to rebuild an image

[![](https://mermaid.ink/img/pako:eNptUctqxDAM_BXhU1uSDfToQ0-FfkCPTQ-KrSSmfuHHQlj236skSx9sfJLl0YxmfBEqaBJS5IKFXg1OCV17fu498Pl4-oS2fYEuxNIxIpUau2zDZDxI2BpQMyXIM1kLD1vt0ZGGHWQylJlA04jV7tjHnfqI8k5qCKFklUwsLDdSUTOg13CmZMYFBuMxLTCm4ODNFIvDAfUfinsnW_-UZ2aPzBLLvu5mYxWayFPiXI5W_pldadegJBjPr5xDRPWFE-UG1Ix--u-_AfZxEo1wlBwazdlfVv5esLSjXkgubwO96P2VoVhLeF-8ErKkSo1IoU6zkCPazLca9e_f3brXb47no_4?type=png)](https://mermaid.live/edit#pako:eNptUctqxDAM_BXhU1uSDfToQ0-FfkCPTQ-KrSSmfuHHQlj236skSx9sfJLl0YxmfBEqaBJS5IKFXg1OCV17fu498Pl4-oS2fYEuxNIxIpUau2zDZDxI2BpQMyXIM1kLD1vt0ZGGHWQylJlA04jV7tjHnfqI8k5qCKFklUwsLDdSUTOg13CmZMYFBuMxLTCm4ODNFIvDAfUfinsnW_-UZ2aPzBLLvu5mYxWayFPiXI5W_pldadegJBjPr5xDRPWFE-UG1Ix--u-_AfZxEo1wlBwazdlfVv5esLSjXkgubwO96P2VoVhLeF-8ErKkSo1IoU6zkCPazLca9e_f3brXb47no_4)

### CI/CD

The Gitlab CI/CD of this project is responsible of building the bootscript,
signing it and publish it to the package registry.
As Gitlab does not have any system to simply get the latest version of a package,
the CI will push 2 versions of the package on tags:

- One with a version number (the short commit sha in our case) for test purposes
- One with the `latest` version that will be downloaded by the `slogin` script

Additionally, the CI will also publish the signature of the bootscript in
another package that will have the same version name.

> ⓘ **Note**
> As Gitlab does not have a system to get the latest version of a package, \
> the pipeline always delete the previous `latest` package before pushing the new one.
> This can lead to a situation where the latest version is deleted but not pushed.
> That's why it is important to ensure the pipeline finishes successfully.

## Step-by-step releases guide

### Arch Avisto image

When the changes you want to make are on the image itself:

> Before starting be sure you run the latest WSL version (see [doc](https://advans-group.atlassian.net/wiki/spaces/DS/pages/2919563271/WSL+2+Get+started#Install%2FUpdate-WSL-2)). \
> Also install [7-zip](https://www.7-zip.org/).

1. Use the [documentation](https://advans-group.atlassian.net/wiki/spaces/DS/pages/2919563271/WSL+2+Get+started#%F0%9F%86%95-Import-Avisto-image-[Recommended])
   to import the image, then login using `wsl -u arch -d <distro-name>`
1. Do your changes
1. Change the `ARCHAVISTO_VERSION` in the `slogin` script to the new version and copy the content of the script in `/opt/startup/slogin`
1. Prep the image by running `source /opt/prep.sh`
1. Open a Powershell
1. Shutdown wsl with `wsl --terminate <distro-name>`
1. Export the distribution as a compressed archive (see the command below)
1. Upload it to the SharePoint (step 1)
1. Make at least 1 person test it
1. Change SharePoint link on the documentation (step 2) to point to the new version
1. Update the `CHANGELOG.md` with the new version and the changes

```python
# Export the distribution as a compressed archive
wsl --export <distro-name> .\arch_avisto_v<semver>.tar
& "C:\Program Files\7-Zip\7z.exe" a .\arch_avisto_v<semver>.tar.gz .\arch_avisto_v<semver>.tar
```

### Bootscript

First, follow all the Avisto guidelines for a new feature (new issue -> create MR/branch -> review -> merge)

Next, here are the steps to test your image:

1. Update the `bootscriptVersion` in the `main.go` (usually located line 15)
1. Check that the pipeline pass once you committed your changes
1. Use the [documentation](https://advans-group.atlassian.net/wiki/spaces/DS/pages/2919563271/WSL+2+Get+started#%F0%9F%86%95-Import-Avisto-image-[Recommended])
   to import the image, then login using `wsl -u root -d <distro-name>`
1. Wait for the pipeline to pass (build & sign & publish)
1. Modify the `curl` statements in the `/opt/startup/slogin` to fetch your version of the bootscript
   (the version name is the short commit sha of your commit—copy the one from Gitlab as it has one more character than on Git)
   for instance, replace `https://versioning.advans-group.com/api/v4/projects/1495/packages/generic/bootscript/latest/bootscript`
   by `https://versioning.advans-group.com/api/v4/projects/1495/packages/generic/bootscript/<your short commit sha>/bootscript` in both lines.
1. Run `su login` and verify all your changes are working properly
1. Update the `CHANGELOG.md` with the new version and the changes
1. If everything is to your liking you can unregister the wsl distro (using `wsl --unregister <distro-name>`), then ask someone to review your MR!
1. Once happy, merge the MR and tag the merge commit on main, it'll create automatically a release and update the permalink

> When someone changes the bootscript, there is no need to either release a new Arch Avisto image nor to redownload the tar for the new bootscrip to be used.

---

# Recreate Arch image from scratch

## Base Instructions

### Distribution installation

Follow this [tutorial](https://wiki.archlinux.org/title/Install_Arch_Linux_on_WSL).

### User creation

**Create 2 users**: arch and login
`useradd -m arch` (to create a home) and `useradd login`.
Also add both users to the wheel group so they can use sudo (`usermod -aG wheel arch` and `usermod -aG wheel login`).

### Login set up

Now login as the arch user `su arch && cd ~`.

**Install paru** using the [documentation](https://github.com/Morganamilo/paru?tab=readme-ov-file#installation) (do it in /tmp preferably).

Create a `/opt/startup` directory and put the `slogin` script found on the arch avisto repo.

Then create a file named `gitlab_token` that will hold a token created with read right on the arch avisto repository.

> [!Note]
> Don't forget to give the ownership of the `/opt/startup` directory to the login user.

Once this is done, time to change the `/etc/passwd` file to modify the default
shell of the login user to `/opt/startup/slogin`, do it by running `sudo chsh -s /opt/startup/slogin login`

and modify the default user to be the login user in the `/etc/wsl.conf` file.

```
[user]
default=login

[boot]
systemd=true
```

> [!Warning]
> From now on, don't forget to start the distribution using `wsl -d <distro> -u arch` to avoid going through the installation script.

## Distribution customization

### Installing docker

To install docker, simply `paru -S docker`
then `sudo systemctl enable docker` and `sudo systemctl start docker`.

> [!Note]
> Don't forget to add the user to the `docker` group `sudo usermod -aG docker arch`.

### Fastfetch

1. Install fastfetch `paru -S fastfetch`.
1. Create the logo using `jp2a --width=45 --colors --color-depth=8 logo\ Avisto.png --chars=' ###'` command with the logo you can find [here](https://groupadvans.sharepoint.com/sites/IntranetADVANSGroup/SitePages/identite-visuelle.aspx).
1. Create the directory `~/.config/fastfetch` and paste the logo in it.
1. Paste the following content in `~/.config/fastfetch/config.jsonc`.

```json
{
  "$schema": "https://github.com/fastfetch-cli/fastfetch/raw/dev/doc/json_schema.json",
  "modules": [
    "title",
    "separator",
    "os",
    "host",
    "kernel",
    "uptime",
    "packages",
    "shell",
    "display",
    "de",
    "wm",
    "terminal",
    "cpu",
    "gpu",
    "memory",
    "swap",
    "disk",
    "localip",
    "battery",
    "poweradapter",
    "break",
    "colors"
  ],
  "logo": {
    "type": "auto",
    "source": "$HOME/.config/fastfetch/avisto-logo"
  }
}
```

### Shells

We provide minimal configuration for all shells proposed in the installation script
first install all shells ( `paru -S fish bash zsh`).

#### Zsh

```bash
if command -v direnv >/dev/null 2>&1; then
  eval "$(direnv hook zsh)"
fi
if command -v starship >/dev/null 2>&1; then
  eval "$(starship init zsh)"
fi

echo; fastfetch; echo;
```

#### Bash

Paste this in the `~/.bash_profile`.

```bash
if command -v direnv >/dev/null 2>&1; then
  eval "$(direnv hook bash)"
fi
if command -v starship >/dev/null 2>&1; then
  eval "$(starship init bash)"
fi

echo; fastfetch; echo;
```

#### Fish

Paste the following in the `~/.config/fish/config.fish`

```fish
if command -v starship > /dev/null 2>&1
    starship init fish | source
end
if command -v direnv > /dev/null 2>&1
    direnv hook fish | source
end

echo; fastfetch; echo;
```

### Generate locale

To generate locale, modify the `/etc/locale.gen` and uncomment your desired locale, then run `sudo locale-gen`
(for instance actual image uses `en_US.UTF-8 UTF-8`).

### Clearing cache

> [!NOTE]
> We advise clearing all cache and shell history before shipping, source that script to do so.

```bash
#! /usr/bin/env bash
paru --noconfirm -R $(paru -Qtdq) || true
paru --noconfirm -Sc || true
rm -rf ~/.cargo
rm -rf ~/.cache
sudo rm -rf /var/cache
sudo rm -rf /var/log
echo "" > ~/.bash_history
history -c
```
