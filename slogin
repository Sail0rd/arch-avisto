#!/bin/sh

BOLDRED="\e[1;31m"
BOLDGREEN="\e[1;32m"
BOLDCYAN="\e[1;36m"
BOLDMAGENTA="\e[1;35m"
ENDCOLOR="\e[0m"

set -o errexit

# GITLAB_TOKEN and public GPG key must be present on the wsl image

# Get the binary and its signature
echo -e "${BOLDCYAN}Downloading the bootscript...${ENDCOLOR}"
curl --fail-with-body --output /opt/startup/bootscript \
        --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
        "https://versioning.advans-group.com/api/v4/projects/1495/packages/generic/bootscript/latest/bootscript"

curl --fail-with-body --output /opt/startup/bootscript.sig \
        --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
        "https://versioning.advans-group.com/api/v4/projects/1495/packages/generic/bootscript.sig/latest/bootscript.sig"

echo -e "${BOLDCYAN}Verifying the signature...${ENDCOLOR}"
sudo gpg --import /opt/startup/gpg_public_key.asc
if ! sudo gpg --verify /opt/startup/bootscript.sig /opt/startup/bootscript; then
        echo -e "${BOLDRED}[ERROR] GPG signature verification failed. Exiting...${ENDCOLOR}"
        exit 1
fi
sleep 1
chmod +x /opt/startup/bootscript

export ARCHAVISTO_VERSION=1.2.0
/opt/startup/bootscript
/opt/startup/script.sh

echo -e "${BOLDGREEN}Installation complete!${ENDCOLOR}"
echo -e "${BOLDCYAN}You can now go back to Powershell and start WSL using the commands ${BOLDMAGENTA}wsl -t <distro-name> ${BOLDCYAN}and then ${BOLDMAGENTA}wsl -d <distro-name>${ENDCOLOR}"
